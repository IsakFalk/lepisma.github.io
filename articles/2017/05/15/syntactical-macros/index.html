<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>
    The Beauty of Syntactical Macros &#8211; abhinav tushar
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="On the importance of code as first class citizen">
  <meta name="author" content="Abhinav Tushar">
  <meta name="keywords" content="articles">
  <link rel="canonical" href="https://lepisma.github.io//articles/2017/05/15/syntactical-macros/">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/assets/css/pace.css" type="text/css">
  <link rel="stylesheet" href="/assets/css/lightbox.css" type="text/css">
  <link rel="stylesheet" href="/assets/css/animate.min.css" type="text/css">
  <link rel="stylesheet" href="/css/blog.css" type="text/css">

  <!-- Favicon -->
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/images/favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/images/favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/images/favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/images/favicons/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/images/favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/images/favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/images/favicons/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/images/favicons/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-196x196.png" sizes="196x196" />
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-128.png" sizes="128x128" />
  <meta name="application-name" content="&nbsp;"/>
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta name="msapplication-TileImage" content="/assets/images/favicons/mstile-144x144.png" />
  <meta name="msapplication-square70x70logo" content="/assets/images/favicons/mstile-70x70.png" />
  <meta name="msapplication-square150x150logo" content="/assets/images/favicons/mstile-150x150.png" />
  <meta name="msapplication-wide310x150logo" content="/assets/images/favicons/mstile-310x150.png" />
  <meta name="msapplication-square310x310logo" content="/assets/images/favicons/mstile-310x310.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,800" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono" rel="stylesheet">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="/assets/js/pace.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="/assets/js/lightbox.min.js"></script>
  <script src="/assets/js/jquery.lettering-0.6.1.min.js"></script>
  <script src="/assets/js/jquery.textillate.js"></script>
  <script src="/assets/js/custom.js"></script>

  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
  <meta property="og:title" content="The Beauty of Syntactical Macros">
  <meta property="og:description" content="Personal Blog">
  <meta property="og:url" content="https://lepisma.github.io//articles/2017/05/15/syntactical-macros/">
  <meta property="og:site_name" content="abhinav tushar">

  <meta name="twitter:url" content="https://lepisma.github.io//articles/2017/05/15/syntactical-macros/">
  <meta name="twitter:title" content="The Beauty of Syntactical Macros">
  <meta name="twitter:description" content="Personal Blog">

  <meta itemprop="name" content="The Beauty of Syntactical Macros">
  <meta itemprop="description" content="Personal Blog">
</head>

  <body>
    <div class="site-wrap">
      <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <span class="site-title">
        <a href="/">
          <img src="/assets/images/avatar32.png">
        </a>
      </span>
      <nav class="site-nav right">
        <a href="/">home</a>
<a href="/feed.xml">feed</a>
<a href="/archive">archive</a>
<a href="/about/">about</a>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>


      <div class="post p2 p-responsive wrap" role="main">
        <div class="measure">
          


<div class="post-header mb2">
  <h1>The Beauty of Syntactical Macros</h1>
  <span class="post-meta small">May 15, 2017</span><br>
  <span class="post-meta small">11 minute read</span>
</div>

<article class="post-content">
  <p><span class="dropcap">I</span>f you think about it, most of what we communicate
can be compiled down to something that is quite <em>literal</em>, which is to say that
a Hollywood AI robot
(like <a href="http://terminator.wikia.com/wiki/T-800_(The_Terminator)">T-800</a>) can read
and understand it mechanically using no more than a dictionary for reference.
For example, when we say</p>

<blockquote>
  <p>My dog is a cheetah</p>
</blockquote>

<p>in a literal sense, all we mean is</p>

<blockquote>
  <p>My dog runs very fast</p>
</blockquote>

<p>Sometimes the transformation is not so direct and we need more context or
language training to convert it to a <em>literal</em> form. An example is the
following:</p>

<blockquote>
  <p>When an elephant is in trouble even a frog will kick him.</p>
</blockquote>

<p>What do we get from these transformations? Occasionally a shorter
representation, specially when they exploit the context. Sometimes its a simple
meaning but with more weight. Sometimes its an indirect way of saying something
to change the flow of emotions. All in all we can agree that they are elegant
rhetorical devices and have a deeper connections with how we communicate and how
our mind evaluates these tiny vagaries.</p>

<p>The <em>literal</em> meaning is what we, as humans, can use (mostly) without ambiguity.
Considering this as the
final <a href="https://www.wikiwand.com/en/Abstract_syntax_tree">AST</a>, the
transformations mentioned above are more than <code class="highlighter-rouge">function</code> calls, which can be
seen as lookups in some instruction manual. These are more akin to Lisp style
<code class="highlighter-rouge">macros</code>.</p>

<h2 id="expressing-programs">Expressing programs</h2>

<p>A programming language allows a really constrained form of expression and so
(fortunately) it needs lesser training to understand a chunk of <em>rhetorical
code</em>, if there is one. There is a limit to how much a programmer can let
his/her words fly without breaking the intended low level syntax tree. But that
limit definitely is above what I have hit, until now.</p>

<p>I have been playing with <a href="https://github.com/hylang/hy">Hy</a>, which is a Lispy
dialect of Python, recently and started using macros. Put simply, they transform
code to code. The input form usually is something we intend to write, the output
being something the computer could understand. An example follows. Forget about
the visual clutter if you are <em>not familiar</em>
with <a href="https://en.wikipedia.org/wiki/S-expression"><em>s-expressions</em></a> in Lisp and
just go through the words, nesting and order.</p>

<div class="language-common-lisp highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nb">defmacro</span> <span class="nv">query-list</span> <span class="nv">[return-cond</span> <span class="nv">from</span> <span class="nv">source-list</span> <span class="nv">where</span> <span class="nv">check-cond</span> <span class="nv">is</span> <span class="nv">item]</span>
  <span class="s">"SQL-ish query on list"</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">try</span>
    <span class="p">(</span><span class="k">let</span> <span class="nv">[item-index</span> <span class="p">(</span><span class="o">.</span><span class="nv">index</span> <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">map</span> <span class="p">(</span><span class="nv">fn</span> <span class="nv">[it]</span> <span class="nv">~check-cond</span><span class="p">)</span> <span class="nv">~source-list</span><span class="p">))</span> <span class="nv">~item</span><span class="p">)</span><span class="nv">]</span>
      <span class="p">((</span><span class="nv">fn</span> <span class="nv">[it]</span> <span class="nv">~return-cond</span><span class="p">)</span> <span class="p">(</span><span class="nb">nth</span> <span class="nv">~source-list</span> <span class="nv">item-index</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">except</span> <span class="nv">[ValueError]</span> <span class="nv">False</span><span class="p">)))</span>
</code></pre>
</div>

<aside>
<div class="aside-title">
S-expressions in Lisp
</div>

Lisp code is represented as a list of items (possibly recursive) which can be
interpreted both as data and code. When interpreted as data, they refer to
themselves, when interpreted as code, the first item is something (a function,
macro) to be applied on the rest.

</aside>

<p>Also forget about the dummy variables (<code class="highlighter-rouge">from</code>, <code class="highlighter-rouge">where</code> …) and hygiene (I am
capturing <code class="highlighter-rouge">it</code>) if you <em>are familiar</em> with Lisp. For reference, here is a
roughly equivalent code in Python for the code generated by that macro (forget
representing this
as
<a href="https://docs.python.org/3/tutorial/datastructures.html#list-comprehensions">list comprehension</a> for
a while, because its not about a specific language feature but how <em>easily</em> we
can add another, possibly specific, feature):</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">item_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">check_cond</span><span class="p">,</span> <span class="n">source_list</span><span class="p">))</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_cond</span><span class="p">(</span><span class="n">source_list</span><span class="p">[</span><span class="n">item_index</span><span class="p">])</span>
<span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre>
</div>

<p>What do I get from this macro? Here is a simple piece which uses this:</p>

<div class="language-common-lisp highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nv">query-list</span> <span class="p">(</span><span class="nb">=</span> <span class="s">"dodo"</span> <span class="nv">it.name</span><span class="p">)</span> <span class="nv">from</span> <span class="nv">animals</span> <span class="nv">where</span> <span class="nv">it.extinction</span> <span class="nv">is</span> <span class="s">"1660s"</span><span class="p">)</span>
</code></pre>
</div>

<p>Just by looking at it, you can sort of see what it is intended for. Indeed this
is a variant of list comprehension. When I was working on the code that needed
this construct, I was thinking of <em>something</em> on the lines of the above example
in my mind. Usually, that <em>something</em> would have gotten converted to a function
representation which would have a certain set of sensibly arranged and named
arguments. But now that I have seen the above <em>valid</em> form, I don’t think a
function would have done justice to the exact <em>expression</em> in my mind and
wouldn’t have been that flexible in its usage.</p>

<p>Another example is with the case of <a href="http://docopt.org/">docopt</a> based argument
parsing. <em>Docopt</em> allows you to write human readable usage instructions for a
command line tool and parses it to a structure we can use in our program.
Although the arguments passed into the command line can be structured in a
nested way, the parsed dictionary returned by <code class="highlighter-rouge">docopt</code> is flat. Consider a
program with usage instruction like the following (items separated by <code class="highlighter-rouge">|</code> are
two options for representing the same thing):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>program task (sub-task-one | sto)
program task (sub-task-two | stt)
program task-two
</code></pre>
</div>

<p>After parsing the arguments, docopt gives a dictionary like so:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"task"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">"sub-task-one"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">"sub-task-two"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">"sto"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">"stt"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">"task-two"</span><span class="p">:</span> <span class="bp">True</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now checking for the values mean using <code class="highlighter-rouge">if</code>s &amp; <code class="highlighter-rouge">else</code>s. Many times its trivial.
Sometimes the nesting can go deep and it becomes messier. When we <em>think</em> about
what to do with these arguments, we think in terms of what each possible
combination is going to do. We think about doing something when we get <code class="highlighter-rouge">task</code>
AND (<code class="highlighter-rouge">sub-task-one</code> OR <code class="highlighter-rouge">sto</code>). Can we directly expose this to our program so
that its readable? Surely, we could do</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">"task"</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"sub-task-one"</span><span class="p">]</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="s">"sto"</span><span class="p">]):</span>
    <span class="o">...</span>
</code></pre>
</div>

<p>This approach does more than nesting <code class="highlighter-rouge">if</code>s because the first test
(<code class="highlighter-rouge">args["task"]</code>) is happening many times, but lets not worry about that since
its not really a heavy computation. There is a repeating pattern here of
<code class="highlighter-rouge">args["&lt;&gt;"]</code>. Repeated patterns are good for machines, but not for us. Its not
that this tiny piece is hurting the readability, its just that I didn’t think
about this thing in my mind while planning to code. This thing actually came in
when I did the transformations from my plan to a computer acceptable construct.
Can we get rid of this then? A quick and simple fix is the following:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="n">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"task"</span><span class="p">,</span> <span class="p">[</span><span class="s">"sub-task-one"</span><span class="p">,</span> <span class="s">"sto"</span><span class="p">]):</span>
    <span class="o">...</span>
</code></pre>
</div>

<p>What the function <code class="highlighter-rouge">check_args</code> does is to collect all the parameters after
<code class="highlighter-rouge">args</code> and put them in a list (call it <code class="highlighter-rouge">*argv</code>). Each of the items in that list
is considered to be joined by <code class="highlighter-rouge">AND</code>s and the next level of nesting is joined by
<code class="highlighter-rouge">OR</code>s. These computations are done by <code class="highlighter-rouge">getting</code> the corresponding value of the
string (the key) from <code class="highlighter-rouge">args</code> dictionary. This is fine. Probably will need some
level of familiarity with the usage but its okay for this trivial case. What
about a deeper level of argument nesting? In that case, for each list at any
level, we could add a string representing the operation to apply on the list
like <code class="highlighter-rouge">and</code> or <code class="highlighter-rouge">or</code>. For more complex transformations and when the arguments are
not just boolean, instead of adding a string, we can just pass a function like
the following:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="n">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">[</span><span class="n">func1</span><span class="p">,</span> <span class="s">"task"</span><span class="p">,</span> <span class="p">[</span><span class="n">func2</span><span class="p">,</span> <span class="s">"subtask"</span><span class="p">,</span> <span class="s">"st"</span><span class="p">]]):</span>
    <span class="o">...</span>
</code></pre>
</div>

<p>See whats happening here? Our arguments are slowly beginning to take form of
code themselves. Nothing wrong in that. But this is not really natural for
Python and it looks out of place from the rest of the code as it needs a
different mental model of whats happening here. Consider the same as a macro in
Hy:</p>

<div class="language-common-lisp highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">check-args</span> <span class="nv">args</span> <span class="p">(</span><span class="nv">func1</span> <span class="s">"task"</span> <span class="p">(</span><span class="nv">func2</span> <span class="s">"subtask"</span> <span class="s">"st"</span><span class="p">)))</span>
  <span class="p">(</span><span class="o">...</span><span class="p">))</span>
</code></pre>
</div>

<p>The macro is also doing the same transformation of replacing the strings with a
<code class="highlighter-rouge">getter</code> corresponding to the dictionary <code class="highlighter-rouge">args</code>, which is something like <code class="highlighter-rouge">(get
args "string")</code>. But its doing nothing other than that. Just like I <em>thought</em>
about the transformation. My first thought was to just run <code class="highlighter-rouge">(func1 "task" (func
"subtask" "st"))</code> by using <code class="highlighter-rouge">args</code> as the context for interpreting the strings.
This is not so in the case of a function. The mental model here is simpler
because there is essentially just one, viz. of <em>s-expressions</em>.</p>

<p>The point is this, programming involves transforming our thoughts to code
constructs and then writing them. Occasionally the output of our transformations
get slightly messy and its feels bad to keep repeating the transformations.
Making functions first class citizen puts us one level up while doing these
transformations. Making code itself first class citizen puts us even higher.
Considering you don’t actually think in Python and are transforming your plain
thoughts to code, the transformations like in the examples shown above are not
at all natural to the approach of <em>just</em> writing functions. Using
<em>s-expressions</em> we get a sweet spot of representation between what is
sufficiently high level and what is understandable by a computer and allows us
this syntactical freedom which is immensely beautiful to peruse, like a
rhetorical device.</p>

<hr />

<p>You shouldn’t write a newspaper with poetic constructs because not everyone is
looking to untangle a string of pearls every morning, however beautiful they
might be. Reading a newspaper is not exactly <em>reading</em> as in <em>“joyfully
devouring words”</em>, its more of an information gathering mechanism and will go
out of fashion if we invent something like an <em>information</em> drink.</p>

<p>There is a certain reason I wasn’t seeing the importance of syntactical macros
and it is the same reason non-standard constructs are avoided in popular
programs. Probably its the same reason it will never be in popular usage for
specific domains. A domain has certain needs which, when satisfied, remove the
need of syntactical extensibility. SQL queries won’t be replaced by Lisp because
if you are going to recreate SQL syntax with Lisp, why even bother with the
switch in the first place? Its only when you crave for extensibility, which is
not very often in practical cases, does it actually reveals its true beauty.</p>

<figure>
<a href="https://xkcd.com/297/">
<img src="https://imgs.xkcd.com/comics/lisp_cycles.png" />
</a>
<figcaption><a href="https://xkcd.com/297/">xkcd - 297</a></figcaption>
</figure>

<p>The most popular languages are the ones with most set standards, certain
important constraints and a lot of directly visible applications (not implying
causality of the opposite side) and they keep gaining traction since its easier
to get started and get going. To focus on the real problem we are solving. But
sometimes, its good to just lay back and play around with the words till they
entertain us on a very personal level. None of what I said is something new
which others haven’t already said about Lisp. The new thing, is just my personal
realization of these facts. I don’t actually believe now that I am seeking
anything like performance (<code class="highlighter-rouge">Hy</code> has certain overheads, although <code class="highlighter-rouge">common-lisp</code> is
crazy fast if used properly) or better productivity (though this is looking like
a very visible long term side effect) with any of the Lisp variants I am
using/going to use but just pure beauty. Probably it will stay that way for a
long time.</p>

</article>

        </div>
      </div>
    </div>

    <footer class="footer">
</footer>

  </body>
</html>
