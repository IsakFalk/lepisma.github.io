<!DOCTYPE html>
<html><head><meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="description" content="Setting up Theano with CUDA acceleration and PyCUDA on Windows."/>
<meta name="author" content="Abhinav Tushar"/>
<meta name="keywords" content=""/>
<link rel="canonical" href="http://localhost:4000/2015/07/30/up-with-theano-and-cuda/"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="Up and running with Theano (GPU) + PyCUDA on Windows"/>
<meta property="og:description" content="Personal Blog"/>
<meta property="og:url" content="http://localhost:4000/2015/07/30/up-with-theano-and-cuda/"/>
<meta property="og:site_name" content="abhinav tushar"/>
<meta name="twitter:url" content="http://localhost:4000/2015/07/30/up-with-theano-and-cuda/"/>
<meta name="twitter:title" content="Up and running with Theano (GPU) + PyCUDA on Windows"/>
<meta name="twitter:description" content="Personal Blog"/>
<meta itemprop="name" content="Up and running with Theano (GPU) + PyCUDA on Windows"/>
<meta itemprop="description" content="Personal Blog"/>
  <title>Up and running with Theano (GPU) + PyCUDA on Windows &#8211; abhinav tushar</title>
  <link rel="stylesheet" href="/assets/css/pace.css" type="text/css"/>
  <link rel="stylesheet" href="/css/blog.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.3/katex.min.css"/><link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/images/favicons/apple-touch-icon-57x57.png"/>
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/images/favicons/apple-touch-icon-114x114.png"/>
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/images/favicons/apple-touch-icon-72x72.png"/>
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/images/favicons/apple-touch-icon-144x144.png"/>
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/images/favicons/apple-touch-icon-60x60.png"/>
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/images/favicons/apple-touch-icon-120x120.png"/>
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/images/favicons/apple-touch-icon-76x76.png"/>
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/images/favicons/apple-touch-icon-152x152.png"/>
<link rel="icon" type="image/png" href="/assets/images/favicons/favicon-196x196.png" sizes="196x196"/>
<link rel="icon" type="image/png" href="/assets/images/favicons/favicon-96x96.png" sizes="96x96"/>
<link rel="icon" type="image/png" href="/assets/images/favicons/favicon-32x32.png" sizes="32x32"/>
<link rel="icon" type="image/png" href="/assets/images/favicons/favicon-16x16.png" sizes="16x16"/>
<link rel="icon" type="image/png" href="/assets/images/favicons/favicon-128.png" sizes="128x128"/>
<meta name="application-name" content="&amp;nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF"/>
<meta name="msapplication-TileImage" content="/assets/images/favicons/mstile-144x144.png"/>
<meta name="msapplication-square70x70logo" content="/assets/images/favicons/mstile-70x70.png"/>
<meta name="msapplication-square150x150logo" content="/assets/images/favicons/mstile-150x150.png"/>
<meta name="msapplication-wide310x150logo" content="/assets/images/favicons/mstile-310x150.png"/>
<meta name="msapplication-square310x310logo" content="/assets/images/favicons/mstile-310x310.png"/><!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,800" rel="stylesheet"/>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono" rel="stylesheet"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="/assets/js/pace.min.js"></script>
  <script src="/assets/js/jquery.zoomooz.min.js"></script>
<script src="http://127.0.0.1:35729/livereload.js"></script></head>
  <body>
    <div class="site-wrap"><header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure"><span class="site-title"><a href="/"><img src="/assets/images/avatar32.png"/></a></span>
      <nav class="site-nav right"><a href="/pile/">pile</a><a href="/feed.xml">feed</a><a href="/archive">blog</a><a href="/about/">about</a></nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>
      <div class="post p2 p-responsive wrap" role="main">
        <div class="measure">

<div class="post-header mb2">
  <div class="post-meta small">Jul 30, 2015</div>
  <div class="post-meta small">7 minute read</div>
  <h1>Up and running with Theano (GPU) + PyCUDA on&nbsp;Windows</h1>
  <div class="post-tags"><a href="/archive/tooling/" rel="tag">tooling</a></div>
</div>
<article class="post-content"><p><span class="dropcap">G</span>etting CUDA to work with python on Windows is
really frustrating. Its not exactly hard, but is sure irritating when you start
doing it. If you have ever tried it, you might be knowing that many possible
combinations of <em>compilers</em>, <em>cuda toolkit</em>, <em>python</em> etc. don’t work.</p>

<p>This post describes the steps that I followed for a working setup of theano
working with GPU acceleration and PyCUDA for general access to GPU from python.
Hopefully, it will help if you haven’t found the sweet spot yet.</p>

<h1 id="setting-up">Setting up</h1>

<p>Starting with my machine, it is a <em>Pavilion DV6 7012tx</em> Laptop with Nvidia
GeForce GT 630m card. Right now its running <em>Windows 10 x64</em>. If you are
already having <code class="highlighter-rouge">cygwin</code> or <code class="highlighter-rouge">mingw</code> based <code class="highlighter-rouge">gcc</code> in place, you might want to
remove that since our scientific python stack will provide that.</p>

<h2 id="1-install-visual-studio">1. Install Visual Studio</h2>

<p>This is needed to get Nvidia’s CUDA compiler (<code class="highlighter-rouge">nvcc</code>) working. For choosing the
version, go to the latest
<a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-microsoft-windows/index.html">CUDA on Windows doc</a>
and see which version of visual studio the current CUDA toolkit supports.</p>

<p>At the time of writing, CUDA 7 was the latest release and Visual Studio 2013 was
the latest supported version. You also don’t need to install 2008 or 2010
version of compiler for python. This will be taken care of later, just go with
everything latest.</p>

<p>After installation, you don’t actually need to add <code class="highlighter-rouge">cl.exe</code> (usually in a
directory like <code class="highlighter-rouge">C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\bin</code>,
depending on your Visual Studio version) to <code class="highlighter-rouge">PATH</code> for theano since we will
define this explicitly in <code class="highlighter-rouge">.theanorc</code>, but it is better to do this as many other
tools might be using it.</p>

<h2 id="2-install-cuda-toolkit">2. Install CUDA toolkit</h2>

<p>This should be easy, get the latest CUDA and install it. Keep the samples while
installing, they are nice for checking if things are working fine.</p>

<h2 id="3-setup-python">3. Setup Python</h2>

<p>This is where most of the trouble is. Its easy to get lost while setting up
vanilla python for theano specially since you also are setting up <code class="highlighter-rouge">gcc</code> and
related tools. The theano installation tutorial will bog you down in this phase
if you don’t actually read it carefully. Most likely you would end up
downloading lots of legacy Visual Studio versions and other stuff. We won’t be
going that way.</p>

<p>Install a scientific python distribution like
<a href="http://continuum.io/downloads">Anaconda</a>. I haven’t tried setting up theano
using other distributions but this should be one of the easier ways because of
<a href="http://conda.pydata.org/docs/#conda">conda</a> package manager. This really
relieves you from setting up a separate <code class="highlighter-rouge">mingw</code> environment and handling
<em>commonly used</em> libraries which are as easy as <code class="highlighter-rouge">conda install boost</code> in
Anaconda.</p>

<p>If you feel Anaconda is a bit too heavy, try
<a href="http://conda.pydata.org/miniconda.html">miniconda</a> and adding basic packages
like <code class="highlighter-rouge">numpy</code> on top of it.</p>

<p>Once you install Anaconda, install additional dependencies.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>conda install mingw libpython
</code></pre>
</div>
<h2 id="4-install-theano">4. Install theano</h2>

<p>Install theano using <code class="highlighter-rouge">pip install theano</code> and create a <code class="highlighter-rouge">.theanorc</code> file in
your <code class="highlighter-rouge">HOME</code> directory with following contents.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[global]
floatX = float32
device = gpu

[nvcc]
flags=-LC:\Anaconda\libs
compiler_bindir=C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\bin
</code></pre>
</div>

<p>Make sure to change the path <code class="highlighter-rouge">C:\Anaconda\libs</code> according to your Anaconda
install directory and <code class="highlighter-rouge">compiler_bindir</code> to the path with <code class="highlighter-rouge">cl.exe</code> in it.</p>

<h2 id="5-install-pycuda">5. Install PyCUDA</h2>

<p>Best way to install PyCUDA is to get the Unofficial Windows Binaries by
Christoph Gohlke <a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/">here</a>.</p>

<p>For quick setup, you can use <a href="https://github.com/lepisma/pipwin">pipwin</a> which
basically automates the process of installing Gohlke’s packages.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>pip install pipwin
pipwin install pycuda
</code></pre>
</div>

<h1 id="test-it-out">Test it out</h1>

<p>A very basic test is to simply import theano.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">theano</span>
<span class="n">Using</span> <span class="n">gpu</span> <span class="n">device</span> <span class="mi">0</span><span class="p">:</span> <span class="n">GeForce</span> <span class="n">GT</span> <span class="mi">630</span><span class="n">M</span> <span class="p">(</span><span class="n">CNMeM</span> <span class="ow">is</span> <span class="n">disabled</span><span class="p">)</span>
</code></pre>
</div>

<p>This should tell you if the GPU is getting used.</p>

<p>One error says that <em>CUDA is installed, but device gpu is not available</em>. For
me, this was solved after installing <code class="highlighter-rouge">mingw</code> and <code class="highlighter-rouge">libpython</code> via conda since
Anaconda doesn’t setup <code class="highlighter-rouge">gcc</code> along with it as it used to do earlier.</p>

<p>For a more extensive test, try the following snippet taken from
<a href="http://deeplearning.net/software/theano/tutorial/using_gpu.html">theano docs</a>.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">function</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">sandbox</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="kn">as</span> <span class="nn">T</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">vlen</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">768</span>  <span class="c"># 10 x #cores x # threads per core</span>
<span class="n">iters</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">vlen</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">function</span><span class="p">([],</span> <span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">maker</span><span class="o">.</span><span class="n">fgraph</span><span class="o">.</span><span class="n">toposort</span><span class="p">()</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span> <span class="s">'Looping </span><span class="si">%</span><span class="s">d times took'</span> <span class="o">%</span> <span class="n">iters</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="s">'seconds'</span>
<span class="k">print</span> <span class="s">'Result is'</span><span class="p">,</span> <span class="n">r</span>
<span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">Elemwise</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">maker</span><span class="o">.</span><span class="n">fgraph</span><span class="o">.</span><span class="n">toposort</span><span class="p">()]):</span>
    <span class="k">print</span> <span class="s">'Used the cpu'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">'Used the gpu'</span>
</code></pre>
</div>

<p>You should see something like this.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">Using</span> <span class="n">gpu</span> <span class="n">device</span> <span class="mi">0</span><span class="p">:</span> <span class="n">GeForce</span> <span class="n">GT</span> <span class="mi">630</span><span class="n">M</span> <span class="p">(</span><span class="n">CNMeM</span> <span class="ow">is</span> <span class="n">disabled</span><span class="p">)</span>
<span class="p">[</span><span class="n">GpuElemwise</span><span class="p">{</span><span class="n">exp</span><span class="p">,</span><span class="n">no_inplace</span><span class="p">}(</span><span class="o">&lt;</span><span class="n">CudaNdarrayType</span><span class="p">(</span><span class="n">float32</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span><span class="o">&gt;</span><span class="p">),</span> <span class="n">HostFromGpu</span><span class="p">(</span><span class="n">GpuElemwise</span><span class="p">{</span><span class="n">exp</span><span class="p">,</span><span class="n">no_inplace</span><span class="p">}</span><span class="o">.</span><span class="mi">0</span><span class="p">)]</span>
<span class="n">Looping</span> <span class="mi">1000</span> <span class="n">times</span> <span class="n">took</span> <span class="mf">1.42199993134</span> <span class="n">seconds</span>
<span class="n">Result</span> <span class="ow">is</span> <span class="p">[</span> <span class="mf">1.23178029</span>  <span class="mf">1.61879349</span>  <span class="mf">1.52278066</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">2.20771813</span>  <span class="mf">2.29967761</span>
  <span class="mf">1.62323296</span><span class="p">]</span>
<span class="n">Used</span> <span class="n">the</span> <span class="n">gpu</span>
</code></pre>
</div>

<p>For PyCUDA, here is a quick test snippet from their <a href="http://documen.tician.de/pycuda/index.html">web
page</a></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pycuda.autoinit</span>
<span class="kn">import</span> <span class="nn">pycuda.driver</span> <span class="kn">as</span> <span class="nn">drv</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">pycuda.compiler</span> <span class="kn">import</span> <span class="n">SourceModule</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">SourceModule</span><span class="p">(</span><span class="s">"""
__global__ void multiply_them(float *dest, float *a, float *b)
{
  const int i = threadIdx.x;
  dest[i] = a[i] * b[i];
}
"""</span><span class="p">)</span>

<span class="n">multiply_them</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="s">"multiply_them"</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">dest</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">multiply_them</span><span class="p">(</span>
        <span class="n">drv</span><span class="o">.</span><span class="n">Out</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="n">drv</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">drv</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
        <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="k">print</span> <span class="n">dest</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">b</span>
</code></pre>
</div>

<p>Seeing an array of zeros ? Its working fine then.</p>

<p>Hopefully, this should give you a working <em>pythonish</em> CUDA setup using the
latest versions of VS, Windows, Python etc.</p>
</article></div>
      </div>
    </div>
    <footer class="footer"></footer>
  </body>
</html>